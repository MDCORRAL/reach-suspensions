<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California School Suspension Analysis | UCLA Education</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #003B5C 0%, #2774AE 100%);
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0, 59, 92, 0.1);
            margin-bottom: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .header h1 {
            color: #003B5C;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #2774AE;
            font-size: 1.2rem;
            max-width: 800px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 59, 92, 0.1);
        }

        .controls h3 {
            color: #003B5C;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filter-group label {
            font-weight: 600;
            color: #2774AE;
            min-width: 120px;
        }

        select, button {
            padding: 0.75rem 1rem;
            border: 2px solid #8BB8E8;
            border-radius: 8px;
            background: white;
            color: #003B5C;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #2774AE;
            box-shadow: 0 0 0 3px rgba(39, 116, 174, 0.1);
        }

        button {
            background: #2774AE;
            color: white;
            border-color: #2774AE;
            font-weight: 600;
        }

        button:hover {
            background: #005587;
            border-color: #005587;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 59, 92, 0.1);
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-container h3 {
            color: #003B5C;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            border-bottom: 3px solid #FFD100;
            padding-bottom: 0.5rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }

        .narrative {
            background: rgba(218, 235, 254, 0.3);
            padding: 1.5rem;
            border-left: 5px solid #FFD100;
            margin-top: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .narrative h4 {
            color: #003B5C;
            margin-bottom: 0.5rem;
        }

        .narrative p {
            color: #005587;
            line-height: 1.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #8BB8E8 0%, #DAEBFE 100%);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            color: #003B5C;
        }

        .stat-card h4 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .highlight {
            background: linear-gradient(90deg, #FFD100, #FFC72C);
            color: #003B5C;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #2774AE;
            font-size: 1.1rem;
        }

        .insight-box {
            background: rgba(255, 184, 28, 0.1);
            border: 2px solid #FFD100;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .insight-box h5 {
            color: #003B5C;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .metric {
            display: inline-block;
            background: #2774AE;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 0.2rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>California School Suspension Analysis</h1>
            <p>Examining disciplinary disparities and trends across traditional and non-traditional educational settings from 2017-2023</p>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <h3>Data Filters & Controls</h3>
            <div class="filter-group">
                <label for="yearSelect">Academic Year:</label>
                <select id="yearSelect">
                    <option value="all">All Years</option>
                    <option value="2017">2017</option>
                    <option value="2018">2018</option>
                    <option value="2019">2019</option>
                    <option value="2021">2021</option>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                </select>
                
                <label for="levelSelect">School Level:</label>
                <select id="levelSelect">
                    <option value="all">All Levels</option>
                    <option value="Elementary">Elementary</option>
                    <option value="Middle">Middle</option>
                    <option value="High">High School</option>
                </select>
                
                <button id="updateCharts">Update Analysis</button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated here -->
        </div>

        <div class="dashboard">
            <div class="chart-container">
                <h3>Suspension Rate Trends Over Time</h3>
                <div class="chart-wrapper">
                    <canvas id="trendsChart"></canvas>
                </div>
                <div class="narrative">
                    <h4>Key Finding: COVID-19 Impact</h4>
                    <p>Suspension rates dropped dramatically from <span class="highlight">5.3% to 3.5%</span> in 2019, reflecting COVID-19's impact on school operations. Rates have since recovered but remain below pre-pandemic levels, suggesting potential lasting changes in disciplinary practices.</p>
                </div>
            </div>

            <div class="chart-container">
                <h3>Traditional vs Non-Traditional Schools</h3>
                <div class="chart-wrapper">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="narrative">
                    <h4>Critical Disparity (2023)</h4>
                    <p>Non-traditional schools show significantly higher suspension rates. High schools show the most dramatic gap: <span class="highlight">9.8%</span> non-traditional vs <span class="highlight">4.6%</span> traditional schools - a 2.1x difference that represents a critical equity issue.</p>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3>School Concentration Analysis (Pareto Effect)</h3>
                <div class="chart-wrapper">
                    <canvas id="paretoChart"></canvas>
                </div>
                <div class="insight-box">
                    <h5>Concentration Pattern:</h5>
                    <p>The data reveals significant concentration where <span class="metric">top 5% of schools</span> account for disproportionate suspension rates, indicating systemic issues in specific institutional settings.</p>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3>Grade Level and Setting Breakdown</h3>
                <div class="chart-wrapper">
                    <canvas id="gradeSettingChart"></canvas>
                </div>
                <div class="narrative">
                    <h4>Setting-Based Disparities</h4>
                    <p>Alternative and non-traditional settings show dramatically higher rates across all grade levels. Elementary traditional schools maintain the lowest rates at <span class="highlight">1.6-1.7%</span>, while alternative high schools reach concerning levels above <span class="highlight">15%</span>.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // UCLA Brand Colors
        const colors = {
            primary: '#2774AE',
            darkest: '#003B5C',
            darker: '#005587',
            lighter: '#8BB8E8',
            lightest: '#DAEBFE',
            gold: '#FFD100',
            darkGold: '#FFC72C',
            white: '#FFFFFF'
        };

        // Embedded data - processed from CSV files
        const EMBEDDED_DATA = {
            summary: [
                {"year_num":2017,"n_schools":9947,"total_enrollment":6870997,"total_suspensions":363203,"mean_rate":0.06437792925707775,"median_rate":0.022336769759450172,"overall_rate":0.05286030542583558,"mean_rate_pct":"6.4%","median_rate_pct":"2.2%","overall_rate_pct":"5.3%"},
                {"year_num":2018,"n_schools":9961,"total_enrollment":6774236,"total_suspensions":353546,"mean_rate":0.06335139656570532,"median_rate":0.021341463414634148,"overall_rate":0.052189796753464156,"mean_rate_pct":"6.3%","median_rate_pct":"2.1%","overall_rate_pct":"5.2%"},
                {"year_num":2019,"n_schools":10064,"total_enrollment":6703797,"total_suspensions":232824,"mean_rate":0.043471881829916736,"median_rate":0.01194386490486635,"overall_rate":0.03473016858953217,"mean_rate_pct":"4.3%","median_rate_pct":"1.2%","overall_rate_pct":"3.5%"},
                {"year_num":2021,"n_schools":10013,"total_enrollment":6515687,"total_suspensions":291907,"mean_rate":0.047435482456641385,"median_rate":0.014957264957264958,"overall_rate":0.044800648036039795,"mean_rate_pct":"4.7%","median_rate_pct":"1.5%","overall_rate_pct":"4.5%"},
                {"year_num":2022,"n_schools":10024,"total_enrollment":6407616,"total_suspensions":336902,"mean_rate":0.05645076887164804,"median_rate":0.019801980198019802,"overall_rate":0.05257836924060368,"mean_rate_pct":"5.6%","median_rate_pct":"2.0%","overall_rate_pct":"5.3%"},
                {"year_num":2023,"n_schools":10002,"total_enrollment":6404542,"total_suspensions":307095,"mean_rate":0.05301101602749898,"median_rate":0.020041757147459635,"overall_rate":0.0479495645434131,"mean_rate_pct":"5.3%","median_rate_pct":"2.0%","overall_rate_pct":"4.8%"}
            ],
            comparison: [
                {"year_num":2017,"level":"Elementary","n_schools_Non-traditional":2,"n_schools_Traditional":1724,"overall_rate_pct_Non-traditional":"1.4%","overall_rate_pct_Traditional":"1.7%","mean_rate_pct_Non-traditional":"1.9%","mean_rate_pct_Traditional":"1.7%","median_rate_pct_Non-traditional":"1.9%","median_rate_pct_Traditional":"0.6%"},
                {"year_num":2017,"level":"High","n_schools_Non-traditional":127,"n_schools_Traditional":966,"overall_rate_pct_Non-traditional":"12.3%","overall_rate_pct_Traditional":"5.2%","mean_rate_pct_Non-traditional":"19.7%","mean_rate_pct_Traditional":"5.5%","median_rate_pct_Non-traditional":"4.3%","median_rate_pct_Traditional":"3.8%"},
                {"year_num":2017,"level":"Middle","n_schools_Non-traditional":107,"n_schools_Traditional":2393,"overall_rate_pct_Non-traditional":"3.7%","overall_rate_pct_Traditional":"5.8%","mean_rate_pct_Non-traditional":"6.1%","mean_rate_pct_Traditional":"5.5%","median_rate_pct_Non-traditional":"1.1%","median_rate_pct_Traditional":"2.6%"},
                {"year_num":2018,"level":"Elementary","n_schools_Non-traditional":2,"n_schools_Traditional":1723,"overall_rate_pct_Non-traditional":"1.1%","overall_rate_pct_Traditional":"1.6%","mean_rate_pct_Non-traditional":"0.7%","mean_rate_pct_Traditional":"1.6%","median_rate_pct_Non-traditional":"0.7%","median_rate_pct_Traditional":"0.5%"},
                {"year_num":2018,"level":"High","n_schools_Non-traditional":130,"n_schools_Traditional":982,"overall_rate_pct_Non-traditional":"11.4%","overall_rate_pct_Traditional":"5.4%","mean_rate_pct_Non-traditional":"18.1%","mean_rate_pct_Traditional":"5.8%","median_rate_pct_Non-traditional":"3.0%","median_rate_pct_Traditional":"3.6%"},
                {"year_num":2018,"level":"Middle","n_schools_Non-traditional":112,"n_schools_Traditional":2414,"overall_rate_pct_Non-traditional":"3.8%","overall_rate_pct_Traditional":"5.6%","mean_rate_pct_Non-traditional":"5.8%","mean_rate_pct_Traditional":"5.3%","median_rate_pct_Non-traditional":"1.0%","median_rate_pct_Traditional":"2.5%"},
                {"year_num":2019,"level":"Elementary","n_schools_Non-traditional":2,"n_schools_Traditional":1740,"overall_rate_pct_Non-traditional":"0.6%","overall_rate_pct_Traditional":"1.1%","mean_rate_pct_Non-traditional":"0.5%","mean_rate_pct_Traditional":"1.1%","median_rate_pct_Non-traditional":"0.5%","median_rate_pct_Traditional":"0.3%"},
                {"year_num":2019,"level":"High","n_schools_Non-traditional":134,"n_schools_Traditional":996,"overall_rate_pct_Non-traditional":"7.8%","overall_rate_pct_Traditional":"3.6%","mean_rate_pct_Non-traditional":"11.8%","mean_rate_pct_Traditional":"3.8%","median_rate_pct_Non-traditional":"1.8%","median_rate_pct_Traditional":"2.4%"},
                {"year_num":2019,"level":"Middle","n_schools_Non-traditional":115,"n_schools_Traditional":2437,"overall_rate_pct_Non-traditional":"2.4%","overall_rate_pct_Traditional":"3.8%","mean_rate_pct_Non-traditional":"3.6%","mean_rate_pct_Traditional":"3.6%","median_rate_pct_Non-traditional":"0.6%","median_rate_pct_Traditional":"1.7%"},
                {"year_num":2021,"level":"Elementary","n_schools_Non-traditional":2,"n_schools_Traditional":1724,"overall_rate_pct_Non-traditional":"0.9%","overall_rate_pct_Traditional":"1.3%","mean_rate_pct_Non-traditional":"0.8%","mean_rate_pct_Traditional":"1.3%","median_rate_pct_Non-traditional":"0.8%","median_rate_pct_Traditional":"0.4%"},
                {"year_num":2021,"level":"High","n_schools_Non-traditional":139,"n_schools_Traditional":1009,"overall_rate_pct_Non-traditional":"9.1%","overall_rate_pct_Traditional":"4.2%","mean_rate_pct_Non-traditional":"13.7%","mean_rate_pct_Traditional":"4.4%","median_rate_pct_Non-traditional":"2.1%","median_rate_pct_Traditional":"2.7%"},
                {"year_num":2021,"level":"Middle","n_schools_Non-traditional":119,"n_schools_Traditional":2420,"overall_rate_pct_Non-traditional":"2.8%","overall_rate_pct_Traditional":"4.4%","mean_rate_pct_Non-traditional":"4.2%","mean_rate_pct_Traditional":"4.2%","median_rate_pct_Non-traditional":"0.8%","median_rate_pct_Traditional":"2.1%"},
                {"year_num":2022,"level":"Elementary","n_schools_Non-traditional":2,"n_schools_Traditional":1722,"overall_rate_pct_Non-traditional":"1.4%","overall_rate_pct_Traditional":"1.6%","mean_rate_pct_Non-traditional":"1.2%","mean_rate_pct_Traditional":"1.6%","median_rate_pct_Non-traditional":"1.2%","median_rate_pct_Traditional":"0.5%"},
                {"year_num":2022,"level":"High","n_schools_Non-traditional":139,"n_schools_Traditional":1021,"overall_rate_pct_Non-traditional":"10.8%","overall_rate_pct_Traditional":"5.0%","mean_rate_pct_Non-traditional":"16.3%","mean_rate_pct_Traditional":"5.3%","median_rate_pct_Non-traditional":"2.5%","median_rate_pct_Traditional":"3.2%"},
                {"year_num":2022,"level":"Middle","n_schools_Non-traditional":120,"n_schools_Traditional":2420,"overall_rate_pct_Non-traditional":"3.3%","overall_rate_pct_Traditional":"5.2%","mean_rate_pct_Non-traditional":"5.0%","mean_rate_pct_Traditional":"5.0%","median_rate_pct_Non-traditional":"1.0%","median_rate_pct_Traditional":"2.5%"},
                {"year_num":2023,"level":"Elementary","n_schools_Non-traditional":2,"n_schools_Traditional":1724,"overall_rate_pct_Non-traditional":"1.1%","overall_rate_pct_Traditional":"1.5%","mean_rate_pct_Non-traditional":"0.9%","mean_rate_pct_Traditional":"1.5%","median_rate_pct_Non-traditional":"0.9%","median_rate_pct_Traditional":"0.5%"},
                {"year_num":2023,"level":"High","n_schools_Non-traditional":140,"n_schools_Traditional":1018,"overall_rate_pct_Non-traditional":"9.8%","overall_rate_pct_Traditional":"4.6%","mean_rate_pct_Non-traditional":"14.6%","mean_rate_pct_Traditional":"4.9%","median_rate_pct_Non-traditional":"2.2%","median_rate_pct_Traditional":"2.9%"},
                {"year_num":2023,"level":"Middle","n_schools_Non-traditional":120,"n_schools_Traditional":2398,"overall_rate_pct_Non-traditional":"3.0%","overall_rate_pct_Traditional":"4.7%","mean_rate_pct_Non-traditional":"4.5%","mean_rate_pct_Traditional":"4.5%","median_rate_pct_Non-traditional":"0.9%","median_rate_pct_Traditional":"2.3%"}
            ],
            pareto: [
                {"year_num":2017,"top_label":"Top 5%","share_pct":"35.3%","top_schools":497,"total_schools":9947,"measure_type":"total_susp"},
                {"year_num":2017,"top_label":"Top 10%","share_pct":"54.0%","top_schools":995,"total_schools":9947,"measure_type":"total_susp"},
                {"year_num":2017,"top_label":"Top 20%","share_pct":"74.6%","top_schools":1989,"total_schools":9947,"measure_type":"total_susp"},
                {"year_num":2018,"top_label":"Top 5%","share_pct":"35.5%","top_schools":498,"total_schools":9961,"measure_type":"total_susp"},
                {"year_num":2018,"top_label":"Top 10%","share_pct":"54.3%","top_schools":996,"total_schools":9961,"measure_type":"total_susp"},
                {"year_num":2018,"top_label":"Top 20%","share_pct":"74.9%","top_schools":1992,"total_schools":9961,"measure_type":"total_susp"}
            ]
        };

        // Global chart storage
        let allCharts = {};
        let currentFilters = { year: 'all', level: 'all' };

        // Initialize the dashboard
        function initDashboard() {
            createStatCards();
            createCharts();
            setupEventListeners();
        }

        // Create statistical overview cards
        function createStatCards() {
            const statsGrid = document.getElementById('statsGrid');
            const latestYear = EMBEDDED_DATA.summary[EMBEDDED_DATA.summary.length - 1];
            
            if (!latestYear) return;

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>${latestYear.n_schools?.toLocaleString() || 'N/A'}</h4>
                    <p>Total Schools (2023)</p>
                </div>
                <div class="stat-card">
                    <h4>${latestYear.total_enrollment?.toLocaleString() || 'N/A'}</h4>
                    <p>Students Enrolled</p>
                </div>
                <div class="stat-card">
                    <h4>${latestYear.total_suspensions?.toLocaleString() || 'N/A'}</h4>
                    <p>Total Suspensions</p>
                </div>
                <div class="stat-card">
                    <h4>${latestYear.overall_rate_pct || 'N/A'}</h4>
                    <p>Overall Suspension Rate</p>
                </div>
            `;
        }

        // Create all charts
        function createCharts() {
            createTrendsChart();
            createComparisonChart();
            createParetoChart();
            createGradeSettingChart();
        }

        // Trends chart
        function createTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            const data = EMBEDDED_DATA.summary.map(d => ({
                year: d.year_num,
                overall: d.overall_rate * 100,
                mean: d.mean_rate * 100,
                median: d.median_rate * 100
            }));

            allCharts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.year),
                    datasets: [{
                        label: 'Overall Rate',
                        data: data.map(d => d.overall),
                        borderColor: colors.primary,
                        backgroundColor: colors.lightest,
                        borderWidth: 4,
                        tension: 0.4,
                        pointBackgroundColor: colors.primary,
                        pointBorderColor: colors.white,
                        pointBorderWidth: 3,
                        pointRadius: 8
                    }, {
                        label: 'Mean Rate',
                        data: data.map(d => d.mean),
                        borderColor: colors.gold,
                        backgroundColor: 'rgba(255, 209, 0, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        pointBackgroundColor: colors.gold,
                        pointRadius: 6
                    }, {
                        label: 'Median Rate',
                        data: data.map(d => d.median),
                        borderColor: colors.darker,
                        backgroundColor: 'rgba(0, 85, 135, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        pointBackgroundColor: colors.darker,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Suspension Rate (%)', font: { size: 14, weight: 'bold' } },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: 'Academic Year', font: { size: 14, weight: 'bold' } }
                        }
                    }
                }
            });
        }

        // Comparison chart between traditional and non-traditional schools
        function createComparisonChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            // Use 2023 data for comparison (most recent)
            const data = EMBEDDED_DATA.comparison
                .filter(d => d.year_num === 2023)
                .map(d => ({
                    level: d.level,
                    traditional: parseFloat(d.overall_rate_pct_Traditional?.replace('%', '') || '0'),
                    nonTraditional: parseFloat(d['overall_rate_pct_Non-traditional']?.replace('%', '') || '0')
                }));

            console.log('Comparison chart data for 2023:', data);

            allCharts.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.level),
                    datasets: [{
                        label: 'Traditional Schools',
                        data: data.map(d => d.traditional),
                        backgroundColor: colors.primary,
                        borderColor: colors.darkest,
                        borderWidth: 2
                    }, {
                        label: 'Non-Traditional Schools',
                        data: data.map(d => d.nonTraditional),
                        backgroundColor: colors.gold,
                        borderColor: colors.darkGold,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Suspension Rate (%)', font: { size: 14, weight: 'bold' } },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Pareto chart showing concentration
        function createParetoChart() {
            const ctx = document.getElementById('paretoChart').getContext('2d');
            
            // Use 2023 or latest data
            const data = EMBEDDED_DATA.pareto
                .filter(d => d.year_num === 2018) // Using 2018 as it has complete data
                .map(d => ({
                    label: d.top_label,
                    share: parseFloat(d.share_pct.replace('%', '')),
                    schools: d.top_schools,
                    total: d.total_schools
                }));

            allCharts.pareto = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.share),
                        backgroundColor: [
                            colors.darkest,
                            colors.primary,
                            colors.gold
                        ],
                        borderColor: colors.white,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                font: { size: 12 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label}: ${data.datasets[0].data[i]}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        index: i
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = data[context.dataIndex];
                                    return `${context.label}: ${context.parsed}% of suspensions (${item.schools} schools)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Grade setting chart placeholder (would use gradeSetting data)
        function createGradeSettingChart() {
            const ctx = document.getElementById('gradeSettingChart').getContext('2d');
            
            // Sample data structure for demonstration
            const sampleData = [
                { level: 'Elementary Traditional', rate: 1.7 },
                { level: 'Elementary Non-traditional', rate: 1.4 },
                { level: 'Middle Traditional', rate: 5.8 },
                { level: 'Middle Non-traditional', rate: 3.7 },
                { level: 'High Traditional', rate: 5.2 },
                { level: 'High Non-traditional', rate: 12.3 }
            ];

            allCharts.gradeSetting = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sampleData.map(d => d.level),
                    datasets: [{
                        label: 'Suspension Rate (%)',
                        data: sampleData.map(d => d.rate),
                        backgroundColor: sampleData.map((d, i) => 
                            d.level.includes('Non-traditional') ? colors.gold : colors.primary
                        ),
                        borderColor: colors.darkest,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Suspension Rate (%)', font: { size: 14, weight: 'bold' } },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y: {
                            title: { display: true, text: 'School Type', font: { size: 14, weight: 'bold' } }
                        }
                    }
                }
            });
        }

        // Update charts based on filters
        function updateCharts() {
            currentFilters.year = document.getElementById('yearSelect').value;
            currentFilters.level = document.getElementById('levelSelect').value;
            
            console.log('Filtering for:', currentFilters);
            
            // Update comparison chart with new year if selected
            if (currentFilters.year !== 'all' && allCharts.comparison) {
                updateComparisonChart(parseInt(currentFilters.year));
            }
            
            // Refresh other charts
            Object.values(allCharts).forEach(chart => {
                if (chart && chart !== allCharts.comparison) {
                    chart.update();
                }
            });
        }

        // Update comparison chart with specific year
        function updateComparisonChart(year) {
            const data = EMBEDDED_DATA.comparison
                .filter(d => d.year_num === year)
                .map(d => ({
                    level: d.level,
                    traditional: parseFloat(d.overall_rate_pct_Traditional?.replace('%', '') || '0'),
                    nonTraditional: parseFloat(d['overall_rate_pct_Non-traditional']?.replace('%', '') || '0')
                }));

            if (data.length > 0) {
                allCharts.comparison.data.labels = data.map(d => d.level);
                allCharts.comparison.data.datasets[0].data = data.map(d => d.traditional);
                allCharts.comparison.data.datasets[1].data = data.map(d => d.nonTraditional);
                allCharts.comparison.update();
                
                // Update narrative based on year
                updateComparisonNarrative(year, data);
            }
        }

        // Update narrative text based on current data
        function updateComparisonNarrative(year, data) {
            const highSchoolData = data.find(d => d.level === 'High');
            if (highSchoolData) {
                const narrative = document.querySelector('.chart-container:nth-child(2) .narrative');
                narrative.innerHTML = `
                    <h4>Critical Disparity (${year})</h4>
                    <p>Non-traditional schools show significantly higher suspension rates. High schools show the most dramatic gap: <span class="highlight">${highSchoolData.nonTraditional}%</span> non-traditional vs <span class="highlight">${highSchoolData.traditional}%</span> traditional schools - a ${Math.round(highSchoolData.nonTraditional / highSchoolData.traditional * 10) / 10}x difference.</p>
                `;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('updateCharts').addEventListener('click', updateCharts);
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>