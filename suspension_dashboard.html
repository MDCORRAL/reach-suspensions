<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California School Suspension Analysis | UCLA Education</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #003B5C 0%, #2774AE 100%);
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0, 59, 92, 0.1);
            margin-bottom: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .header h1 {
            color: #003B5C;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #2774AE;
            font-size: 1.2rem;
            max-width: 800px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 59, 92, 0.1);
        }

        .controls h3 {
            color: #003B5C;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filter-group label {
            font-weight: 600;
            color: #2774AE;
            min-width: 120px;
        }

        select, button {
            padding: 0.75rem 1rem;
            border: 2px solid #8BB8E8;
            border-radius: 8px;
            background: white;
            color: #003B5C;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #2774AE;
            box-shadow: 0 0 0 3px rgba(39, 116, 174, 0.1);
        }

        button {
            background: #2774AE;
            color: white;
            border-color: #2774AE;
            font-weight: 600;
        }

        button:hover {
            background: #005587;
            border-color: #005587;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 59, 92, 0.1);
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-container h3 {
            color: #003B5C;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            border-bottom: 3px solid #FFD100;
            padding-bottom: 0.5rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }

        .narrative {
            background: rgba(218, 235, 254, 0.3);
            padding: 1.5rem;
            border-left: 5px solid #FFD100;
            margin-top: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .narrative h4 {
            color: #003B5C;
            margin-bottom: 0.5rem;
        }

        .narrative p {
            color: #005587;
            line-height: 1.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #8BB8E8 0%, #DAEBFE 100%);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            color: #003B5C;
        }

        .stat-card h4 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .highlight {
            background: linear-gradient(90deg, #FFD100, #FFC72C);
            color: #003B5C;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #2774AE;
            font-size: 1.1rem;
        }

        .insight-box {
            background: rgba(255, 184, 28, 0.1);
            border: 2px solid #FFD100;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .insight-box h5 {
            color: #003B5C;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .metric {
            display: inline-block;
            background: #2774AE;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 0.2rem;
        }
    </style>
</head>
<body>

  <div style="padding:1rem; text-align:right;">
  <a href="index.html" style="color:white; font-weight:600; text-decoration:underline;">
    ‚Üê Back to Main Dashboard
  </a>
</div>

    <div class="header">
        <div class="container">
            <h1>California School Suspension Analysis</h1>
            <p>Examining disciplinary disparities and trends across traditional and non-traditional educational settings from 2017-2023</p>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <h3>Data Filters & Controls</h3>
            <div class="filter-group">
                <label for="yearSelect">Academic Year:</label>
                <select id="yearSelect">
                    <option value="all">All Years</option>
                    <option value="2017">2017</option>
                    <option value="2018">2018</option>
                    <option value="2019">2019</option>
                    <option value="2021">2021</option>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                </select>
                
                <label for="levelSelect">School Level:</label>
                <select id="levelSelect">
                    <option value="all">All Levels</option>
                    <option value="Elementary">Elementary</option>
                    <option value="Middle">Middle</option>
                    <option value="High">High School</option>
                </select>
                
                <button id="updateCharts">Update Analysis</button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated here -->
        </div>

        <div class="dashboard">
            <div class="chart-container">
                <h3>Suspension Rate Trends Over Time</h3>
                <div class="chart-wrapper">
                    <canvas id="trendsChart"></canvas>
                </div>
                <div class="narrative">
                    <h4>Key Finding: COVID-19 Impact</h4>
                    <p>Suspension rates dropped dramatically from <span class="highlight">5.3% to 3.5%</span> in 2019, reflecting COVID-19's impact on school operations. Rates have since recovered but remain below pre-pandemic levels, suggesting potential lasting changes in disciplinary practices.</p>
                </div>
            </div>

            <div class="chart-container">
                <h3>Traditional vs Non-Traditional Schools</h3>
                <div class="chart-wrapper">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="narrative">
                    <h4>Critical Disparity (2023)</h4>
                    <p>Non-traditional schools show significantly higher suspension rates. High schools show the most dramatic gap: <span class="highlight">9.8%</span> non-traditional vs <span class="highlight">4.6%</span> traditional schools - a 2.1x difference that represents a critical equity issue.</p>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3>School Concentration Analysis (Pareto Effect)</h3>
                <div class="chart-wrapper">
                    <canvas id="paretoChart"></canvas>
                </div>
                <div class="insight-box">
                    <h5>Concentration Pattern:</h5>
                    <p>The data reveals significant concentration where <span class="metric">top 5% of schools</span> account for disproportionate suspension rates, indicating systemic issues in specific institutional settings.</p>
                </div>
            </div>

            <div class="chart-container full-width">
                <h3>Grade Level and Setting Breakdown</h3>
                <div class="chart-wrapper">
                    <canvas id="gradeSettingChart"></canvas>
                </div>
                <div class="narrative">
                    <h4>Setting-Based Disparities</h4>
                    <p>Alternative and non-traditional settings show dramatically higher rates across all grade levels. Elementary traditional schools remain the lowest, while non-traditional high schools reach double-digit suspension rates.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // UCLA Brand Colors
        const colors = {
            primary: '#2774AE',
            darkest: '#003B5C',
            darker: '#005587',
            lighter: '#8BB8E8',
            lightest: '#DAEBFE',
            gold: '#FFD100',
            darkGold: '#FFC72C',
            white: '#FFFFFF'
        };

        const DATA_URL = `dashboard/data/suspension_dashboard.json?v=${Date.now()}`;
        const DATA_BUNDLE_SRC = 'dashboard/data/suspension_dashboard.js';

        let EMBEDDED_DATA = {
            summary: [],
            gradeSetting: [],
            comparison: [],
            pareto: []
        };

        function getPreloadedData() {
            if (typeof window === 'undefined') return null;
            const payload = window.SUSPENSION_DASHBOARD_DATA;
            if (payload && Array.isArray(payload.summary)) {
                return payload;
            }
            return null;
        }

        function normalisePayload(payload = {}) {
            return {
                summary: Array.isArray(payload.summary) ? payload.summary : [],
                gradeSetting: Array.isArray(payload.gradeSetting) ? payload.gradeSetting : [],
                comparison: Array.isArray(payload.comparison) ? payload.comparison : [],
                pareto: Array.isArray(payload.pareto) ? payload.pareto : []
            };
        }

        function ensureDataBundleLoaded() {
            if (typeof window === 'undefined') {
                return Promise.reject(new Error('No browser environment available.'));
            }
            const existing = getPreloadedData();
            if (existing) {
                return Promise.resolve(existing);
            }
            return new Promise((resolve, reject) => {
                const selector = 'script[data-suspension-bundle]';
                let script = document.querySelector(selector);

                const resolveWithPayload = () => {
                    const payload = getPreloadedData();
                    if (payload) {
                        resolve(payload);
                    } else {
                        if (script && script.dataset) {
                            script.dataset.suspensionBundleState = 'error';
                        }
                        reject(new Error('Bundle loaded but data missing'));
                    }
                };

                const handleLoad = () => {
                    if (script && script.dataset) {
                        script.dataset.suspensionBundleState = 'loaded';
                    }
                    resolveWithPayload();
                };

                const handleError = () => {
                    if (script && script.dataset) {
                        script.dataset.suspensionBundleState = 'error';
                    }
                    reject(new Error('Failed to load precomputed data bundle'));
                };

                const monitorExistingScript = () => {
                    if (!script) {
                        return false;
                    }
                    const state = script.dataset ? script.dataset.suspensionBundleState : undefined;
                    if (state === 'loaded') {
                        resolveWithPayload();
                        return true;
                    }
                    if (state === 'error') {
                        reject(new Error('Failed to load precomputed data bundle'));
                        return true;
                    }
                    const readyState = script.readyState;
                    if (readyState === 'complete' || readyState === 'loaded') {
                        if (script.dataset) {
                            script.dataset.suspensionBundleState = 'loaded';
                        }
                        resolveWithPayload();
                        return true;
                    }
                    if (readyState === 'error') {
                        if (script.dataset) {
                            script.dataset.suspensionBundleState = 'error';
                        }
                        reject(new Error('Failed to load precomputed data bundle'));
                        return true;
                    }
                    return false;
                };

                if (script) {
                    if (monitorExistingScript()) {
                        return;
                    }
                    script.addEventListener('load', handleLoad, { once: true });
                    script.addEventListener('error', handleError, { once: true });
                    return;
                }

                script = document.createElement('script');
                script.src = DATA_BUNDLE_SRC;
                script.dataset.suspensionBundle = 'true';
                if (script.dataset) {
                    script.dataset.suspensionBundleState = 'pending';
                }
                script.addEventListener('load', handleLoad, { once: true });
                script.addEventListener('error', handleError, { once: true });
                document.head.appendChild(script);
            });
        }

        async function fetchDashboardData() {
            try {
                const response = await fetch(DATA_URL, { cache: 'no-store' });
                if (!response.ok) throw new Error('Unable to load dataset');
                const payload = await response.json();
                if (payload && (Array.isArray(payload.summary) || Array.isArray(payload.gradeSetting))) {
                    return payload;
                }
                throw new Error('Dataset missing expected arrays');
            } catch (error) {
                console.warn('Direct JSON request for prepared data failed:', error);
                return ensureDataBundleLoaded();
            }
        }

        function showLoadError(message) {
            const main = document.querySelector('main');
            if (main) {
                main.innerHTML = `<div class="panel"><p>${message}</p></div>`;
            }
        }


        // Global chart storage
        let allCharts = {};
        let currentFilters = { year: 'all', level: 'all' };

        // Initialize the dashboard
        function initDashboard() {
            if (!Array.isArray(EMBEDDED_DATA.summary) || EMBEDDED_DATA.summary.length === 0) {
                showLoadError('No suspension overview data available.');
                return;
            }
            createStatCards();
            createCharts();
            setupEventListeners();
        }

        async function bootstrapDashboard() {
            try {
                const payload = await fetchDashboardData();
                EMBEDDED_DATA = normalisePayload(payload);
                initDashboard();
            } catch (error) {
                console.error('Failed to load suspension dashboard data', error);
                showLoadError('Unable to load suspension overview data. Please refresh to try again.');
            }
        }

        // Create statistical overview cards
        function createStatCards() {
            const statsGrid = document.getElementById('statsGrid');
            const latestYear = EMBEDDED_DATA.summary[EMBEDDED_DATA.summary.length - 1];
            
            if (!latestYear) return;

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>${latestYear.n_schools?.toLocaleString() || 'N/A'}</h4>
                    <p>Total Schools (2023)</p>
                </div>
                <div class="stat-card">
                    <h4>${latestYear.total_enrollment?.toLocaleString() || 'N/A'}</h4>
                    <p>Students Enrolled</p>
                </div>
                <div class="stat-card">
                    <h4>${latestYear.total_suspensions?.toLocaleString() || 'N/A'}</h4>
                    <p>Total Suspensions</p>
                </div>
                <div class="stat-card">
                    <h4>${latestYear.overall_rate_pct || 'N/A'}</h4>
                    <p>Overall Suspension Rate</p>
                </div>
            `;
        }

        // Create all charts
        function createCharts() {
            createTrendsChart();
            createComparisonChart();
            createParetoChart();
            createGradeSettingChart();
        }

        // Trends chart
        function createTrendsChart() {
            updateTrendsChart('all'); // Start with all levels
        }

        function updateTrendsChart(selectedLevel = 'all') {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            let data;
            if (selectedLevel === 'all') {
                // Use overall summary data
                data = EMBEDDED_DATA.summary.map(d => ({
                    year: d.year_num,
                    overall: d.overall_rate * 100,
                    mean: d.mean_rate * 100,
                    median: d.median_rate * 100
                }));
            } else {
                // Calculate aggregate stats for the selected level
                const years = [...new Set(EMBEDDED_DATA.gradeSetting.map(d => d.year_num))].sort();
                data = years.map(year => {
                    const yearLevelData = EMBEDDED_DATA.gradeSetting.filter(d =>
                        d.year_num === year && d.level === selectedLevel
                    );

                    if (yearLevelData.length === 0) return null;

                    // Calculate weighted overall rate
                    const totalEnrollment = yearLevelData.reduce((sum, d) => sum + (d.total_enrollment || 0), 0);
                    const totalSuspensions = yearLevelData.reduce((sum, d) => sum + (d.total_suspensions || 0), 0);
                    const overallRate = totalEnrollment > 0 ? (totalSuspensions / totalEnrollment) * 100 : 0;

                    // Calculate mean rate approximated by weighting each school's rate equally via school counts
                    const totalSchools = yearLevelData.reduce((sum, d) => sum + (d.n_schools || 0), 0);
                    const meanRate = totalSchools > 0
                        ? yearLevelData.reduce((sum, d) => sum + ((d.overall_rate || 0) * (d.n_schools || 0)), 0) / totalSchools * 100
                        : 0;

                    // Approximate median using school counts to avoid overlapping with overall rate
                    const sortedByRate = [...yearLevelData].sort((a, b) => (a.overall_rate || 0) - (b.overall_rate || 0));
                    let cumulativeSchools = 0;
                    let medianRate = 0;
                    const halfSchools = totalSchools / 2;

                    for (const record of sortedByRate) {
                        cumulativeSchools += record.n_schools || 0;
                        if (cumulativeSchools >= halfSchools) {
                            medianRate = (record.overall_rate || 0) * 100;
                            break;
                        }
                    }

                    return {
                        year: year,
                        overall: overallRate,
                        mean: meanRate,
                        median: medianRate
                    };
                }).filter(d => d !== null);
            }

            if (allCharts.trends) {
                allCharts.trends.destroy();
            }

            allCharts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.year),
                    datasets: [{
                        label: selectedLevel === 'all' ? 'Overall Rate' : `${selectedLevel} Overall Rate`,
                        data: data.map(d => d.overall),
                        borderColor: colors.primary,
                        backgroundColor: colors.lightest,
                        borderWidth: 4,
                        tension: 0.4,
                        pointBackgroundColor: colors.primary,
                        pointBorderColor: colors.white,
                        pointBorderWidth: 3,
                        pointRadius: 8
                    }, {
                        label: selectedLevel === 'all' ? 'Mean Rate' : `${selectedLevel} Mean Rate`,
                        data: data.map(d => d.mean),
                        borderColor: colors.gold,
                        backgroundColor: 'rgba(255, 209, 0, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        pointBackgroundColor: colors.gold,
                        pointBorderColor: colors.white,
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }, {
                        label: selectedLevel === 'all' ? 'Median Rate' : `${selectedLevel} Median Rate`,
                        data: data.map(d => d.median),
                        borderColor: colors.darker,
                        backgroundColor: 'rgba(0, 85, 135, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        pointBackgroundColor: colors.darker,
                        pointBorderColor: colors.white,
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Suspension Rate (%)', font: { size: 14, weight: 'bold' } },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: 'Academic Year', font: { size: 14, weight: 'bold' } }
                        }
                    }
                }
            });
        }

        // Comparison chart between traditional and non-traditional schools
        function createComparisonChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            // Use 2023 data for comparison (most recent)
            const data = EMBEDDED_DATA.comparison
                .filter(d => d.year_num === 2023)
                .map(d => ({
                    level: d.level,
                    traditional: parseFloat(d.overall_rate_pct_Traditional?.replace('%', '') || '0'),
                    nonTraditional: parseFloat(d['overall_rate_pct_Non-traditional']?.replace('%', '') || '0')
                }));

            console.log('Comparison chart data for 2023:', data);

            allCharts.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.level),
                    datasets: [{
                        label: 'Traditional Schools',
                        data: data.map(d => d.traditional),
                        backgroundColor: colors.primary,
                        borderColor: colors.darkest,
                        borderWidth: 2
                    }, {
                        label: 'Non-Traditional Schools',
                        data: data.map(d => d.nonTraditional),
                        backgroundColor: colors.gold,
                        borderColor: colors.darkGold,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Suspension Rate (%)', font: { size: 14, weight: 'bold' } },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Pareto chart showing concentration
        function createParetoChart() {
            updateParetoChart(2023, 'all'); // Start with 2023 data
        }

        function updateParetoChart(selectedYear = 2023, selectedLevel = 'all') {
            try {
                const ctx = document.getElementById('paretoChart').getContext('2d');

                const buildOverallPareto = () => EMBEDDED_DATA.pareto
                    .filter(d => d.year_num === selectedYear)
                    .map(d => ({
                        label: d.top_label,
                        share: parseFloat(d.share_pct.replace('%', '')),
                        schools: d.top_schools,
                        total: d.total_schools
                    }));

                const buildLevelPareto = () => {
                    const levelRecords = EMBEDDED_DATA.gradeSetting.filter(d =>
                        d.year_num === selectedYear && d.level === selectedLevel
                    );

                    if (levelRecords.length === 0) {
                        return [];
                    }

                    const totalSchools = levelRecords.reduce((sum, d) => sum + (d.n_schools || 0), 0);
                    const totalSuspensions = levelRecords.reduce((sum, d) => sum + (d.total_suspensions || 0), 0);

                    if (totalSchools === 0 || totalSuspensions === 0) {
                        return [];
                    }

                    const grouped = levelRecords
                        .map(d => ({
                            label: d.setting,
                            nSchools: d.n_schools || 0,
                            totalSusp: d.total_suspensions || 0,
                            suspPerSchool: (d.n_schools || 0) > 0
                                ? (d.total_suspensions || 0) / d.n_schools
                                : 0
                        }))
                        .sort((a, b) => b.suspPerSchool - a.suspPerSchool);

                    const thresholds = [
                        { label: 'Top 5%', fraction: 0.05 },
                        { label: 'Top 10%', fraction: 0.10 },
                        { label: 'Top 20%', fraction: 0.20 }
                    ];

                    return thresholds.map(threshold => {
                        const targetSchools = Math.max(1, Math.round(totalSchools * threshold.fraction));
                        let schoolsAccum = 0;
                        let suspensionsAccum = 0;

                        for (const group of grouped) {
                            if (schoolsAccum >= targetSchools) break;

                            const remaining = targetSchools - schoolsAccum;
                            const takeSchools = Math.min(remaining, group.nSchools);

                            if (group.nSchools > 0 && group.totalSusp > 0) {
                                const proportion = takeSchools / group.nSchools;
                                suspensionsAccum += group.totalSusp * proportion;
                            }

                            schoolsAccum += takeSchools;
                        }

                        const share = (suspensionsAccum / totalSuspensions) * 100;

                        return {
                            label: threshold.label,
                            share: Math.round(share * 10) / 10,
                            schools: targetSchools,
                            total: totalSchools
                        };
                    });
                };

                const data = selectedLevel === 'all'
                    ? buildOverallPareto()
                    : buildLevelPareto();

                console.log('Building pareto chart for year:', selectedYear, 'level:', selectedLevel);

                if (allCharts.pareto) {
                    allCharts.pareto.destroy();
                }

                allCharts.pareto = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.label),
                        datasets: [{
                            data: data.map(d => d.share),
                            backgroundColor: [
                                colors.darkest,
                                colors.primary,
                                colors.gold
                            ],
                            borderColor: colors.white,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    font: { size: 12 },
                                    generateLabels: function(chart) {
                                        const chartData = chart.data;
                                        return chartData.labels.map((label, i) => ({
                                            text: `${label}: ${chartData.datasets[0].data[i]}%`,
                                            fillStyle: chartData.datasets[0].backgroundColor[i],
                                            index: i
                                        }));
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const item = data[context.dataIndex];
                                        return `${context.label}: ${context.parsed}% of suspensions (${item.schools} schools)`;
                                    }
                                }
                            }
                        }
                    }
                });

                console.log('Pareto chart created successfully');

                // Update the insight box
                const insightBox = document.querySelector('.chart-container:nth-child(3) .insight-box');
                const topFivePercent = data.find(d => d.label === 'Top 5%');
                if (topFivePercent && insightBox) {
                    insightBox.innerHTML = `
                        <h5>Concentration Pattern (${selectedYear}${selectedLevel !== 'all' ? ` ‚Ä¢ ${selectedLevel}` : ''}):</h5>
                        <p>The data reveals significant concentration where <span class="metric">top 5% of schools</span> account for <span class="metric">${topFivePercent.share}%</span> of all suspensions, indicating systemic issues in specific institutional settings.</p>
                    `;
                } else if (insightBox) {
                    insightBox.innerHTML = `
                        <h5>Concentration Pattern (${selectedYear}${selectedLevel !== 'all' ? ` ‚Ä¢ ${selectedLevel}` : ''}):</h5>
                        <p>Insufficient data is available to estimate concentration patterns for the selected filters.</p>
                    `;
                }

            } catch (error) {
                console.error('Error in updateParetoChart:', error);
            }
        }

        // Grade setting chart
        function createGradeSettingChart() {
            updateGradeSettingChart(2023, 'all'); // Start with 2023, all levels
        }

        function updateGradeSettingChart(selectedYear = 2023, selectedLevel = 'all') {
            try {
                const ctx = document.getElementById('gradeSettingChart').getContext('2d');
                
                let filteredData = EMBEDDED_DATA.gradeSetting.filter(d => d.year_num === selectedYear);
                
                if (selectedLevel !== 'all') {
                    filteredData = filteredData.filter(d => d.level === selectedLevel);
                } else {
                    // Show all levels but filter out Alternative and Other/Unknown for clarity
                    filteredData = filteredData.filter(d => ['Elementary', 'Middle', 'High'].includes(d.level));
                }

                // Prepare data for chart
                const chartData = filteredData.map(d => ({
                    label: `${d.level} (${d.setting})`,
                    rate: d.overall_rate * 100,
                    setting: d.setting,
                    level: d.level,
                    schools: d.n_schools
                })).sort((a, b) => {
                    // Sort by level first, then by setting (Traditional first)
                    if (a.level !== b.level) {
                        const levelOrder = {'Elementary': 0, 'Middle': 1, 'High': 2};
                        return levelOrder[a.level] - levelOrder[b.level];
                    }
                    return a.setting === 'Traditional' ? -1 : 1;
                });

                console.log('Building grade setting chart for year:', selectedYear, 'level:', selectedLevel);

                if (allCharts.gradeSetting) {
                    allCharts.gradeSetting.destroy();
                }

                allCharts.gradeSetting = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => d.label),
                        datasets: [{
                            label: 'Suspension Rate (%)',
                            data: chartData.map(d => d.rate),
                            backgroundColor: chartData.map(d => 
                                d.setting === 'Non-traditional' ? colors.gold : colors.primary
                            ),
                            borderColor: colors.darkest,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const item = chartData[context.dataIndex];
                                        return `${context.parsed.x.toFixed(1)}% (${item.schools} schools)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'Suspension Rate (%)', font: { size: 14, weight: 'bold' } },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            y: {
                                title: { display: true, text: 'School Type', font: { size: 14, weight: 'bold' } }
                            }
                        }
                    }
                });

                console.log('Grade setting chart created successfully');

                // Update narrative
                updateGradeSettingNarrative(selectedYear, chartData);
                
            } catch (error) {
                console.error('Error in updateGradeSettingChart:', error);
            }
        }

        function updateGradeSettingNarrative(year, data) {
            try {
                const narrative = document.querySelector('.chart-container:nth-child(4) .narrative');
                if (narrative && data.length > 0) {
                    const highestRate = Math.max(...data.map(d => d.rate));
                    const lowestRate = Math.min(...data.map(d => d.rate));
                    const highestItem = data.find(d => d.rate === highestRate);
                    const lowestItem = data.find(d => d.rate === lowestRate);
                    const ratio = Math.round(highestRate / lowestRate * 10) / 10;

                    narrative.innerHTML = `
                        <h4>Setting-Based Disparities (${year})</h4>
                        <p>Significant variation exists across school types and settings. The highest rate is <span class="highlight">${highestRate.toFixed(1)}%</span> in ${highestItem.label}, while the lowest is <span class="highlight">${lowestRate.toFixed(1)}%</span> in ${lowestItem.label} - a ${ratio}x difference.</p>
                    `;
                }
            } catch (error) {
                console.error('Error in updateGradeSettingNarrative:', error);
            }
        }

        // Update charts based on filters
        function updateCharts() {
            try {
                // Debug function availability
                console.log('Function check:');
                console.log('updateTrendsChart available:', typeof updateTrendsChart);
                console.log('refreshComparisonChart available:', typeof refreshComparisonChart);
                console.log('updateParetoChart available:', typeof updateParetoChart);
                console.log('updateGradeSettingChart available:', typeof updateGradeSettingChart);
                console.log('updateComparisonChartDisplay available:', typeof updateComparisonChartDisplay);
                
                currentFilters.year = document.getElementById('yearSelect').value;
                currentFilters.level = document.getElementById('levelSelect').value;
                
                console.log('Updating all charts for year:', currentFilters.year, 'level:', currentFilters.level);
                
                const year = currentFilters.year === 'all' ? 2023 : parseInt(currentFilters.year);
                const level = currentFilters.level;
                
                // Update trends chart with level filter
                console.log('1. Updating trends chart...');
                if (typeof updateTrendsChart === 'function') {
                    updateTrendsChart(level);
                } else {
                    console.error('updateTrendsChart is not a function');
                }
                
                // Update chart title to show active filter
                const trendsTitle = document.querySelector('.chart-container:nth-child(1) h3');
                if (trendsTitle) {
                    if (level === 'all') {
                        trendsTitle.textContent = 'Suspension Rate Trends Over Time';
                    } else {
                        trendsTitle.textContent = `${level} School Suspension Rate Trends Over Time`;
                    }
                }
                
                // Update comparison chart with year filter
                console.log('2. Updating comparison chart for year:', year);
                
                // Direct inline function call - no separate function reference
                try {
                    const ctx = document.getElementById('comparisonChart').getContext('2d');
                    
                    const chartData = EMBEDDED_DATA.comparison
                        .filter(d => d.year_num === year)
                        .map(d => ({
                            level: d.level,
                            traditional: parseFloat(d.overall_rate_pct_Traditional?.replace('%', '') || '0'),
                            nonTraditional: parseFloat(d['overall_rate_pct_Non-traditional']?.replace('%', '') || '0')
                        }));

                    console.log('Inline building comparison chart for year:', year, 'with', chartData.length, 'records');

                    // Destroy old chart
                    if (allCharts.comparison) {
                        allCharts.comparison.destroy();
                    }

                    // Build new chart
                    allCharts.comparison = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartData.map(d => d.level),
                            datasets: [{
                                label: 'Traditional Schools',
                                data: chartData.map(d => d.traditional),
                                backgroundColor: colors.primary,
                                borderColor: colors.darkest,
                                borderWidth: 2
                            }, {
                                label: 'Non-Traditional Schools',
                                data: chartData.map(d => d.nonTraditional),
                                backgroundColor: colors.gold,
                                borderColor: colors.darkGold,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        padding: 20,
                                        font: { size: 12, weight: 'bold' }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Suspension Rate (%)', font: { size: 14, weight: 'bold' } },
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log('Inline comparison chart created successfully');
                    
                    // Update narrative inline
                    const highData = chartData.find(d => d.level === 'High');
                    if (highData) {
                        const narrative = document.querySelector('.chart-container:nth-child(2) .narrative');
                        if (narrative) {
                            const ratio = Math.round(highData.nonTraditional / highData.traditional * 10) / 10;
                            narrative.innerHTML = `
                                <h4>Critical Disparity (${year})</h4>
                                <p>Non-traditional schools show significantly higher suspension rates. High schools show the most dramatic gap: <span class="highlight">${highData.nonTraditional}%</span> non-traditional vs <span class="highlight">${highData.traditional}%</span> traditional schools - a ${ratio}x difference.</p>
                            `;
                        }
                    }
                    
                } catch (comparisonError) {
                    console.error('Error in inline comparison chart update:', comparisonError);
                }
                
                // Update chart title to show active year
                const comparisonTitle = document.querySelector('.chart-container:nth-child(2) h3');
                if (comparisonTitle) {
                    if (currentFilters.year !== 'all') {
                        comparisonTitle.textContent = `Traditional vs Non-Traditional Schools (${year})`;
                    } else {
                        comparisonTitle.textContent = 'Traditional vs Non-Traditional Schools (2023)';
                    }
                }
                
                // Update pareto chart with year filter
                console.log('3. Updating pareto chart for year:', year, 'level:', level);
                if (typeof updateParetoChart === 'function') {
                    updateParetoChart(year, level);
                } else {
                    console.error('updateParetoChart is not a function');
                }

                // Update chart title to show active year
                const paretoTitle = document.querySelector('.chart-container:nth-child(3) h3');
                if (paretoTitle) {
                    let paretoText = `School Concentration Analysis - ${year} (Pareto Effect)`;
                    if (level !== 'all') {
                        paretoText = `${level} School Concentration Analysis - ${year} (Pareto Effect)`;
                    }
                    paretoTitle.textContent = paretoText;
                }
                
                // Update grade setting chart with both filters
                console.log('4. Updating grade setting chart for year:', year, 'level:', level);
                if (typeof updateGradeSettingChart === 'function') {
                    updateGradeSettingChart(year, level);
                } else {
                    console.error('updateGradeSettingChart is not a function');
                }
                
                // Update chart title to show active filters
                const gradeTitle = document.querySelector('.chart-container:nth-child(4) h3');
                if (gradeTitle) {
                    let titleText = `Grade Level and Setting Breakdown (${year})`;
                    if (level !== 'all') {
                        titleText = `${level} Schools by Setting (${year})`;
                    }
                    gradeTitle.textContent = titleText;
                }
                
                // Update trend narrative based on level
                console.log('5. Updating trend narrative...');
                if (typeof updateTrendsNarrative === 'function') {
                    updateTrendsNarrative(level);
                } else {
                    console.error('updateTrendsNarrative is not a function');
                }
                
                console.log('All chart updates completed successfully');
                
            } catch (error) {
                console.error('Error updating charts:', error);
                console.error('Error stack:', error.stack);
            }
        }

        // Update trends narrative based on current filter
        function updateTrendsNarrative(selectedLevel) {
            try {
                const narrative = document.querySelector('.chart-container:nth-child(1) .narrative');
                let narrativeText = '';
                
                if (selectedLevel === 'all') {
                    narrativeText = `
                        <h4>Key Finding: COVID-19 Impact</h4>
                        <p>Suspension rates dropped dramatically from <span class="highlight">5.3% to 3.5%</span> in 2019, reflecting COVID-19's impact on school operations. Rates have since recovered but remain below pre-pandemic levels, suggesting potential lasting changes in disciplinary practices.</p>
                    `;
                } else {
                    // Get trend data for the specific level
                    const years = [2017, 2018, 2019, 2021, 2022, 2023];
                    const levelData = years.map(year => {
                        const yearData = EMBEDDED_DATA.gradeSetting.filter(d => 
                            d.year_num === year && d.level === selectedLevel
                        );
                        const totalEnrollment = yearData.reduce((sum, d) => sum + d.total_enrollment, 0);
                        const totalSuspensions = yearData.reduce((sum, d) => sum + d.total_suspensions, 0);
                        return totalEnrollment > 0 ? (totalSuspensions / totalEnrollment) * 100 : 0;
                    });
                    
                    const pre2019 = levelData[1]; // 2018
                    const pandemic = levelData[2]; // 2019
                    const latest = levelData[5]; // 2023
                    
                    narrativeText = `
                        <h4>${selectedLevel} Schools: COVID-19 Impact</h4>
                        <p>${selectedLevel} schools saw rates change from <span class="highlight">${pre2019.toFixed(1)}%</span> (2018) to <span class="highlight">${pandemic.toFixed(1)}%</span> (2019), with current rates at <span class="highlight">${latest.toFixed(1)}%</span> (2023).</p>
                    `;
                }
                
                if (narrative) {
                    narrative.innerHTML = narrativeText;
                }
            } catch (error) {
                console.error('Error in updateTrendsNarrative:', error);
            }
        }

        // Update comparison chart with specific year
        function updateComparisonChart(year) {
            try {
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
                const data = EMBEDDED_DATA.comparison
                    .filter(d => d.year_num === year)
                    .map(d => ({
                        level: d.level,
                        traditional: parseFloat(d.overall_rate_pct_Traditional?.replace('%', '') || '0'),
                        nonTraditional: parseFloat(d['overall_rate_pct_Non-traditional']?.replace('%', '') || '0')
                    }));

                console.log('Building comparison chart for year:', year);
                console.log('Data found:', data.length, 'records');

                if (allCharts.comparison) {
                    allCharts.comparison.destroy();
                }

                allCharts.comparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.level),
                        datasets: [{
                            label: 'Traditional Schools',
                            data: data.map(d => d.traditional),
                            backgroundColor: colors.primary,
                            borderColor: colors.darkest,
                            borderWidth: 2
                        }, {
                            label: 'Non-Traditional Schools',
                            data: data.map(d => d.nonTraditional),
                            backgroundColor: colors.gold,
                            borderColor: colors.darkGold,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 20,
                                    font: { size: 12, weight: 'bold' }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Suspension Rate (%)', font: { size: 14, weight: 'bold' } },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('Comparison chart created successfully');
                
                // Update narrative
                if (data.length > 0) {
                    updateComparisonNarrative(year, data);
                }
                
            } catch (error) {
                console.error('Error in updateComparisonChart:', error);
                console.error('Error stack in updateComparisonChart:', error.stack);
            }
        }

        // Update comparison chart with specific year
        function updateComparisonChart(year) {
            updateComparisonChartDisplay(year);
            
            // Update narrative
            const data = EMBEDDED_DATA.comparison
                .filter(d => d.year_num === year)
                .map(d => ({
                    level: d.level,
                    traditional: parseFloat(d.overall_rate_pct_Traditional?.replace('%', '') || '0'),
                    nonTraditional: parseFloat(d['overall_rate_pct_Non-traditional']?.replace('%', '') || '0')
                }));
            
            if (data.length > 0) {
                updateComparisonNarrative(year, data);
            }
        }

        // Update narrative text based on current data
        function updateComparisonNarrative(year, data) {
            try {
                const highSchoolData = data.find(d => d.level === 'High');
                if (highSchoolData) {
                    const narrative = document.querySelector('.chart-container:nth-child(2) .narrative');
                    if (narrative) {
                        const ratio = Math.round(highSchoolData.nonTraditional / highSchoolData.traditional * 10) / 10;
                        narrative.innerHTML = `
                            <h4>Critical Disparity (${year})</h4>
                            <p>Non-traditional schools show significantly higher suspension rates. High schools show the most dramatic gap: <span class="highlight">${highSchoolData.nonTraditional}%</span> non-traditional vs <span class="highlight">${highSchoolData.traditional}%</span> traditional schools - a ${ratio}x difference.</p>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error in updateComparisonNarrative:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('updateCharts').addEventListener('click', updateCharts);
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', bootstrapDashboard);
    </script>
</body>
</html>